# .github/workflows/sync-upstream.yml
# Fully automatic upstream sync with security gate
# If security passes â†’ auto-merge to main
# If security fails â†’ workflow fails, main untouched

name: Sync Upstream

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-and-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/0xHoneyJar/loa.git || true
          git fetch upstream main --depth=100

      - name: Check for changes
        id: check
        run: |
          CHANGES=$(git rev-list --count HEAD..upstream/main 2>/dev/null || echo "0")
          echo "count=$CHANGES" >> $GITHUB_OUTPUT

          if [ "$CHANGES" -gt 0 ]; then
            echo "## ðŸ“¦ $CHANGES new commits from upstream" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git log --oneline HEAD..upstream/main >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Already up to date" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Security audit - Secrets
        if: steps.check.outputs.count != '0'
        id: secrets
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”’ Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PATTERNS="(api[_-]?key|secret|password|token|credential|private[_-]?key)\s*[:=]\s*['\"][^'\"]{8,}"
          DIFF=$(git diff HEAD...upstream/main -- '*.sh' '*.js' '*.ts' '*.json' '*.yml' 2>/dev/null | grep -E "^\+" | grep -iE "$PATTERNS" | grep -vi "example\|template\|placeholder\|YOUR_\|TODO\|CHANGEME\|xxx" || true)

          if [ -n "$DIFF" ]; then
            echo "### ðŸš¨ BLOCKED: Potential secrets detected" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$DIFF" | head -15 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "### âœ… Secrets: Clean" >> $GITHUB_STEP_SUMMARY
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Security audit - Network calls
        if: steps.check.outputs.count != '0'
        run: |
          PATTERNS="curl\s|wget\s|fetch\(|axios\.|http\.request|https\.request"
          DIFF=$(git diff HEAD...upstream/main -- '*.sh' '*.js' '*.ts' 2>/dev/null | grep -E "^\+" | grep -iE "$PATTERNS" || true)

          if [ -n "$DIFF" ]; then
            echo "### âš ï¸ Network calls added (review in diff)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Network: Clean" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Security audit - Dangerous patterns
        if: steps.check.outputs.count != '0'
        run: |
          PATTERNS="eval\(|new Function\(|child_process\.(exec|spawn)"
          DIFF=$(git diff HEAD...upstream/main -- '*.sh' '*.js' '*.ts' 2>/dev/null | grep -E "^\+" | grep -E "$PATTERNS" || true)

          if [ -n "$DIFF" ]; then
            echo "### âš ï¸ Eval/exec patterns (review in diff)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Dangerous patterns: Clean" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Security audit - Beads
        if: steps.check.outputs.count != '0'
        run: |
          CHANGES=$(git diff HEAD...upstream/main --name-only -- '.beads/*' 2>/dev/null || true)

          if [ -n "$CHANGES" ]; then
            echo "### âš ï¸ Bead scripts modified (ceoOS uses --skip-beads)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Beads: Clean" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Block if secrets found
        if: steps.secrets.outputs.found == 'true'
        run: |
          echo ""
          echo "::error::Security audit FAILED - potential secrets in upstream changes"
          echo "::error::Review the diff manually before merging"
          exit 1

      - name: Merge upstream to main
        if: steps.check.outputs.count != '0' && steps.secrets.outputs.found != 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          git merge upstream/main --no-edit
          git push origin main

          echo "## âœ… Auto-merged to main" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security audit passed. ${{ steps.check.outputs.count }} commits merged." >> $GITHUB_STEP_SUMMARY

      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.count }}" = "0" ]; then
            echo "**Result:** No changes to sync" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.secrets.outputs.found }}" = "true" ]; then
            echo "**Result:** âŒ Blocked - manual review required" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Result:** âœ… Synced successfully" >> $GITHUB_STEP_SUMMARY
          fi
