# .github/workflows/sync-upstream.yml
# Automatically sync fork from upstream daily
# Creates sync branch + runs security audit (no elevated permissions needed)

name: Sync Upstream

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

# Only needs default read permissions + write to push branch
permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      sync_branch: ${{ steps.push.outputs.branch }}

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/0xHoneyJar/loa.git || true
          git fetch upstream main --depth=100

      - name: Check for changes
        id: check
        run: |
          CHANGES=$(git rev-list --count origin/main..upstream/main 2>/dev/null || echo "0")

          if [ "$CHANGES" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "## ðŸ“¦ $CHANGES new commits from upstream" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git log --oneline origin/main..upstream/main >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "## âœ… Already up to date" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create and push sync branch
        id: push
        if: steps.check.outputs.has_changes == 'true'
        run: |
          BRANCH="sync/upstream-$(date +%Y%m%d)"
          git checkout -b "$BRANCH"
          git merge upstream/main --no-edit
          git push origin "$BRANCH" --force
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”€ Branch Created: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To review and merge:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to repository â†’ Branches â†’ \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Click **Compare & pull request**" >> $GITHUB_STEP_SUMMARY
          echo "3. Review security audit below" >> $GITHUB_STEP_SUMMARY
          echo "4. Merge when satisfied" >> $GITHUB_STEP_SUMMARY

  security-audit:
    needs: sync
    if: needs.sync.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.sync.outputs.sync_branch }}
          fetch-depth: 0

      - name: Fetch main
        run: git fetch origin main

      - name: Scan - Network calls
        id: network
        run: |
          echo "## ðŸŒ Network Calls" >> $GITHUB_STEP_SUMMARY
          PATTERNS="curl|wget|fetch\(|axios|http\.get|https\.get"
          DIFF=$(git diff origin/main...HEAD -- '*.sh' '*.js' '*.ts' 2>/dev/null | grep -E "^\+" | grep -iE "$PATTERNS" || true)

          if [ -n "$DIFF" ]; then
            echo "::warning::New network calls detected"
            echo "### âš ï¸ New network calls found" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$DIFF" | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… None added" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Scan - Secrets
        id: secrets
        run: |
          echo "## ðŸ”‘ Secret Patterns" >> $GITHUB_STEP_SUMMARY
          PATTERNS="api[_-]?key|secret|password|token|credential|private[_-]?key"
          DIFF=$(git diff origin/main...HEAD -- '*.sh' '*.js' '*.ts' '*.json' '*.yml' 2>/dev/null | grep -E "^\+" | grep -iE "$PATTERNS" | grep -vi "example\|template\|placeholder\|YOUR_\|TODO" || true)

          if [ -n "$DIFF" ]; then
            echo "::error::Potential secrets detected!"
            echo "### ðŸš¨ POTENTIAL SECRETS" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$DIFF" | head -15 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… None found" >> $GITHUB_STEP_SUMMARY
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Scan - Eval/Exec
        run: |
          echo "## âš ï¸ Dangerous Patterns" >> $GITHUB_STEP_SUMMARY
          PATTERNS="eval\(|exec\(|child_process|spawn\(|Function\("
          DIFF=$(git diff origin/main...HEAD -- '*.sh' '*.js' '*.ts' 2>/dev/null | grep -E "^\+" | grep -E "$PATTERNS" || true)

          if [ -n "$DIFF" ]; then
            echo "::warning::eval/exec patterns found"
            echo "### âš ï¸ Review needed" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$DIFF" | head -15 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… None found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Scan - Beads
        run: |
          echo "## ðŸ“¿ Bead Scripts" >> $GITHUB_STEP_SUMMARY
          CHANGES=$(git diff origin/main...HEAD --name-only -- '.beads/*' 2>/dev/null || true)

          if [ -n "$CHANGES" ]; then
            echo "::warning::Bead scripts changed"
            echo "### âš ï¸ Modified (ceoOS uses --skip-beads)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$CHANGES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No changes" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if secrets
        if: steps.secrets.outputs.found == 'true'
        run: |
          echo "::error::Security audit failed - review required"
          exit 1
